name: Despligue continuo

on:
  push:
    branches:
      - feature/config-next-to-deploy   # Cambia si usas otra rama
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Desplegar en CentOS Stream 9
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ“¦ Actualizando proyecto..."
            cd ${{ secrets.MARCELL_PATH }}

            # Verificar estado actual
            echo "ğŸ“‹ Estado actual del repositorio:"
            git status
            git log --oneline -5

            # Pull desde GitHub
            echo "â¬‡ï¸ Descargando cambios desde GitHub..."
            git pull origin feature/config-next-to-deploy

            # Verificar cambios descargados
            echo "ğŸ“‹ Cambios descargados:"
            git log --oneline -3

            # Limpiar cachÃ© de npm
            echo "ğŸ§¹ Limpiando cachÃ©..."
            npm cache clean --force

            # Eliminar node_modules y package-lock.json para instalaciÃ³n limpia
            echo "ğŸ—‘ï¸ Eliminando dependencias anteriores..."
            rm -rf node_modules package-lock.json

            # Instalar dependencias
            echo "ğŸ“¦ Instalando dependencias..."
            npm install

            # Limpiar build anterior
            echo "ğŸ§¹ Limpiando build anterior..."
            rm -rf .next

            # Construir proyecto en modo producciÃ³n
            echo "ğŸ”¨ Construyendo proyecto..."
            NODE_ENV=production npm run build

            # Verificar que el build se completÃ³ correctamente
            if [ ! -d ".next" ]; then
              echo "âŒ Error: El build no se completÃ³ correctamente"
              exit 1
            fi

            # Crear directorio de logs si no existe
            mkdir -p logs

            echo "ğŸ”„ Reiniciando aplicaciÃ³n con PM2..."
            
            # Detener proceso existente si existe
            pm2 delete tesis 2>/dev/null || echo "No habÃ­a proceso previo"
            
            # Iniciar con configuraciÃ³n de ecosystem
            pm2 start ecosystem.config.js
            
            # Guardar configuraciÃ³n de PM2
            pm2 save

            # Verificar estado de PM2
            echo "ğŸ“Š Estado de PM2:"
            pm2 list
            pm2 logs tesis --lines 10

            # Limpiar cachÃ© de nginx si es necesario
            echo "ğŸ”„ Reiniciando nginx..."
            sudo systemctl reload nginx

            echo "âœ… Despliegue completado"
            echo "ğŸŒ La aplicaciÃ³n deberÃ­a estar disponible en: https://tutupaca.unjbg.edu.pe/marcell"

      - name: ğŸ” Verificar despliegue
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ” Ejecutando verificaciÃ³n post-despliegue..."
            cd ${{ secrets.MARCELL_PATH }}
            
            # Esperar un momento para que la aplicaciÃ³n se inicie completamente
            sleep 15
            
            # Verificar estado del proceso
            echo "ğŸ“Š Estado final de PM2:"
            pm2 list
            
            # Verificar logs
            echo "ğŸ“„ Logs recientes:"
            pm2 logs tesis --lines 20
            
            # Verificar conectividad
            echo "ğŸŒ Verificando conectividad local:"
            curl -I http://localhost:3005/marcell 2>/dev/null | head -1 || echo "âŒ No se puede conectar localmente"
            
            # Verificar archivos de build
            echo "ğŸ“ Verificando archivos de build:"
            ls -la .next/
            
            # Verificar variables de entorno
            echo "ğŸ”§ Verificando variables de entorno:"
            echo "NODE_ENV: $NODE_ENV"
            echo "PORT: $PORT"
            
            echo "âœ… VerificaciÃ³n completada"