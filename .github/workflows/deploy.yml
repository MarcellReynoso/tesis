name: Despligue continuo

on:
  push:
    branches:
      - master   # Cambia si usas otra rama
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Desplegar en CentOS Stream 9
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ“¦ Actualizando proyecto..."
            cd ${{ secrets.MARCELL_PATH }}

            # Verificar estado actual
            echo "ğŸ“‹ Estado actual del repositorio:"
            git status
            git log --oneline -5

            # Guardar cambios locales (como .env) antes del pull
            echo "ğŸ’¾ Guardando cambios locales..."
            git stash push -m "Cambios locales antes del pull - $(date)"

            # Pull desde GitHub
            echo "â¬‡ï¸ Descargando cambios desde GitHub..."
            git pull origin master

            # Restaurar cambios locales (como .env)
            echo "ğŸ”„ Restaurando cambios locales..."
            git stash pop || echo "No hay cambios locales para restaurar"

            # Verificar cambios descargados
            echo "ğŸ“‹ Cambios descargados:"
            git log --oneline -3

            # Limpiar cachÃ© de npm
            echo "ğŸ§¹ Limpiando cachÃ©..."
            npm cache clean --force

            # Eliminar node_modules y package-lock.json para instalaciÃ³n limpia
            echo "ğŸ—‘ï¸ Eliminando dependencias anteriores..."
            rm -rf node_modules package-lock.json

            # Instalar dependencias
            echo "ğŸ“¦ Instalando dependencias..."
            npm install

            # Limpiar build anterior
            echo "ğŸ§¹ Limpiando build anterior..."
            rm -rf .next

            # Construir proyecto en modo producciÃ³n
            echo "ğŸ”¨ Construyendo proyecto..."
            NODE_ENV=production npm run build

            # Verificar que el build se completÃ³ correctamente
            if [ ! -d ".next" ]; then
              echo "âŒ Error: El build no se completÃ³ correctamente"
              exit 1
            fi

            # Crear directorio de logs si no existe
            mkdir -p logs

            echo "ğŸ”„ Reiniciando aplicaciÃ³n con PM2..."
            
            # Detener proceso existente si existe
            pm2 delete tesis 2>/dev/null || echo "No habÃ­a proceso previo"
            
            # Verificar que estamos en el directorio correcto
            echo "ğŸ“ Directorio actual: $(pwd)"
            
            # Verificar que ecosystem.config.js existe
            if [ ! -f "ecosystem.config.js" ]; then
              echo "âŒ Error: ecosystem.config.js no existe"
              exit 1
            fi
            
            # Iniciar con configuraciÃ³n de ecosystem
            echo "ğŸš€ Iniciando PM2..."
            pm2 start ecosystem.config.js
            
            # Verificar estado
            echo "ğŸ“Š Estado de PM2:"
            pm2 list
            
            # Guardar configuraciÃ³n de PM2
            pm2 save

            # Limpiar cachÃ© de nginx si es necesario
            echo "ğŸ”„ Reiniciando nginx..."
            sudo systemctl reload nginx

            echo "âœ… Despliegue completado"
            echo "ğŸŒ La aplicaciÃ³n deberÃ­a estar disponible en: https://tutupaca.unjbg.edu.pe/marcell"