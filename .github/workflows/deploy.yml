name: Despligue continuo

on:
  push:
    branches:
      - feature/config-next-to-deploy   # Cambia si usas otra rama
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Desplegar en CentOS Stream 9
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ“¦ Actualizando proyecto..."
            cd ${{ secrets.MARCELL_PATH }}

            # Verificar estado actual
            echo "ğŸ“‹ Estado actual del repositorio:"
            git status
            git log --oneline -5

            # Guardar cambios locales (como .env) antes del pull
            echo "ğŸ’¾ Guardando cambios locales..."
            git stash push -m "Cambios locales antes del pull - $(date)"

            # Pull desde GitHub
            echo "â¬‡ï¸ Descargando cambios desde GitHub..."
            git pull origin feature/config-next-to-deploy

            # Restaurar cambios locales (como .env)
            echo "ğŸ”„ Restaurando cambios locales..."
            git stash pop || echo "No hay cambios locales para restaurar"

            # Verificar cambios descargados
            echo "ğŸ“‹ Cambios descargados:"
            git log --oneline -3

            # Limpiar cachÃ© de npm
            echo "ğŸ§¹ Limpiando cachÃ©..."
            npm cache clean --force

            # Eliminar node_modules y package-lock.json para instalaciÃ³n limpia
            echo "ğŸ—‘ï¸ Eliminando dependencias anteriores..."
            rm -rf node_modules package-lock.json

            # Instalar dependencias
            echo "ğŸ“¦ Instalando dependencias..."
            npm install

            # Limpiar build anterior
            echo "ğŸ§¹ Limpiando build anterior..."
            rm -rf .next

            # Construir proyecto en modo producciÃ³n
            echo "ğŸ”¨ Construyendo proyecto..."
            NODE_ENV=production npm run build

            # Verificar que el build se completÃ³ correctamente
            if [ ! -d ".next" ]; then
              echo "âŒ Error: El build no se completÃ³ correctamente"
              exit 1
            fi

            # Crear directorio de logs si no existe
            mkdir -p logs

            echo "ğŸ”„ Reiniciando aplicaciÃ³n con PM2..."
            
            # Detener proceso existente si existe
            pm2 delete tesis 2>/dev/null || echo "No habÃ­a proceso previo"
            
            # Verificar que estamos en el directorio correcto
            echo "ğŸ“ Directorio actual: $(pwd)"
            echo "ğŸ“ Contenido del directorio:"
            ls -la
            
            # Verificar que ecosystem.config.js existe
            if [ ! -f "ecosystem.config.js" ]; then
              echo "âŒ Error: ecosystem.config.js no existe"
              exit 1
            fi
            
            # Mostrar configuraciÃ³n de PM2
            echo "ğŸ“‹ ConfiguraciÃ³n de PM2:"
            cat ecosystem.config.js
            
            # Iniciar con configuraciÃ³n de ecosystem
            echo "ğŸš€ Iniciando PM2..."
            pm2 start ecosystem.config.js
            
            # Verificar estado inmediatamente
            echo "ğŸ“Š Estado inmediato de PM2:"
            pm2 list
            
            # Esperar un momento y verificar de nuevo
            sleep 5
            echo "ğŸ“Š Estado despuÃ©s de 5 segundos:"
            pm2 list
            
            # Verificar logs si hay error
            if pm2 list | grep -q "errored"; then
              echo "âŒ Error detectado en PM2. Mostrando logs:"
              pm2 logs tesis --lines 50
              echo "ğŸ“„ Logs de error:"
              cat logs/err.log 2>/dev/null || echo "No hay archivo de error"
              echo "ğŸ“„ Logs de salida:"
              cat logs/out.log 2>/dev/null || echo "No hay archivo de salida"
            else
              echo "âœ… PM2 iniciado correctamente"
              pm2 logs tesis --lines 10
            fi
            
            # Guardar configuraciÃ³n de PM2
            pm2 save

            # Limpiar cachÃ© de nginx si es necesario
            echo "ğŸ”„ Reiniciando nginx..."
            sudo systemctl reload nginx

            echo "âœ… Despliegue completado"
            echo "ğŸŒ La aplicaciÃ³n deberÃ­a estar disponible en: https://tutupaca.unjbg.edu.pe/marcell"

      - name: ğŸ” Verificar despliegue
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ” Ejecutando verificaciÃ³n post-despliegue..."
            cd ${{ secrets.MARCELL_PATH }}
            
            # Esperar un momento para que la aplicaciÃ³n se inicie completamente
            sleep 15
            
            # Verificar estado del proceso
            echo "ğŸ“Š Estado final de PM2:"
            pm2 list
            
            # Verificar logs
            echo "ğŸ“„ Logs recientes:"
            pm2 logs tesis --lines 20
            
            # Verificar conectividad
            echo "ğŸŒ Verificando conectividad local:"
            curl -I http://localhost:3005/marcell 2>/dev/null | head -1 || echo "âŒ No se puede conectar localmente"
            
            # Verificar archivos de build
            echo "ğŸ“ Verificando archivos de build:"
            ls -la .next/
            
            # Verificar variables de entorno
            echo "ğŸ”§ Verificando variables de entorno:"
            echo "NODE_ENV: $NODE_ENV"
            echo "PORT: $PORT"
            
            echo "âœ… VerificaciÃ³n completada"